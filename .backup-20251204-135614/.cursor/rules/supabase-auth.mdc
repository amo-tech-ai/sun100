# Supabase Auth - Cursor Rule

## Overview

Supabase Auth provides authentication, authorization, and user management. This rule covers React integration, OAuth providers (Google), session management, and security best practices.

**References:**
- [Supabase Auth React Quickstart](https://supabase.com/docs/guides/auth/quickstarts/react)
- [Supabase Google OAuth](https://supabase.com/docs/guides/auth/social-login/auth-google)

---

## Core Setup

### ✅ CORRECT: Create Supabase Client

**React/Vite:**
```typescript
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;

if (!supabaseUrl || !supabaseAnonKey) {
  throw new Error('Missing Supabase environment variables');
}

export const supabase = createClient(supabaseUrl, supabaseAnonKey, {
  auth: {
    persistSession: true,
    autoRefreshToken: true,
  },
});
```

**Environment Variables (.env.local):**
```bash
VITE_SUPABASE_URL=https://xxxxx.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key
# OR use new publishable key:
VITE_SUPABASE_PUBLISHABLE_DEFAULT_KEY=sb_publishable_xxx
```

### ✅ CORRECT: Check Session on Mount

```typescript
import { useEffect, useState } from 'react';
import { Session } from '@supabase/supabase-js';
import { supabase } from './lib/supabaseClient';

function App() {
  const [session, setSession] = useState<Session | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // Get initial session
    supabase.auth.getSession().then(({ data: { session } }) => {
      setSession(session);
      setLoading(false);
    });

    // Listen for auth changes
    const {
      data: { subscription },
    } = supabase.auth.onAuthStateChange((_event, session) => {
      setSession(session);
    });

    return () => subscription.unsubscribe();
  }, []);

  if (loading) return <div>Loading...</div>;
  if (!session) return <Login />;
  return <Dashboard />;
}
```

---

## Google OAuth Setup

### ✅ CORRECT: Google OAuth Sign-In

**Simple OAuth Flow:**
```typescript
const handleGoogleSignIn = async () => {
  const { error } = await supabase.auth.signInWithOAuth({
    provider: 'google',
    options: {
      redirectTo: `${window.location.origin}/auth/callback`,
    },
  });

  if (error) {
    console.error('Google sign-in error:', error);
  }
  // User will be redirected to Google, then back to callback
};
```

### ✅ CORRECT: Handle OAuth Callback

**File:** `screens/AuthCallback.tsx`

```typescript
import { useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { supabase } from '../lib/supabaseClient';

const AuthCallback: React.FC = () => {
  const navigate = useNavigate();

  useEffect(() => {
    const handleCallback = async () => {
      // Supabase automatically handles the OAuth callback
      // Just check for session after redirect
      const { data: { session }, error } = await supabase.auth.getSession();
      
      if (error) {
        navigate('/login?error=auth_failed');
        return;
      }

      if (session) {
        navigate('/dashboard');
      } else {
        navigate('/login?error=no_session');
      }
    };

    handleCallback();
  }, [navigate]);

  return <div>Completing sign in...</div>;
};
```

### ✅ CORRECT: PKCE Flow (Server-Side Rendering)

**For Next.js or SSR:**
```typescript
// Callback route handler
const { data, error } = await supabase.auth.exchangeCodeForSession(code);

if (error) {
  // Handle error
}

// Session is now available
const { data: { session } } = await supabase.auth.getSession();
```

---

## Session Management

### ✅ CORRECT: Get Current Session

```typescript
const { data: { session }, error } = await supabase.auth.getSession();

if (session) {
  console.log('User:', session.user);
  console.log('Access token:', session.access_token);
}
```

### ✅ CORRECT: Listen for Auth Changes

```typescript
useEffect(() => {
  const {
    data: { subscription },
  } = supabase.auth.onAuthStateChange((event, session) => {
    console.log('Auth event:', event); // SIGNED_IN, SIGNED_OUT, TOKEN_REFRESHED
    setSession(session);
    
    if (event === 'SIGNED_IN') {
      // User signed in
    } else if (event === 'SIGNED_OUT') {
      // User signed out
    }
  });

  return () => subscription.unsubscribe();
}, []);
```

### ✅ CORRECT: Sign Out

```typescript
const handleLogout = async () => {
  const { error } = await supabase.auth.signOut();
  
  if (error) {
    console.error('Sign out error:', error);
  } else {
    // User signed out, redirect to login
    navigate('/login');
  }
};
```

---

## Email/Password Auth

### ✅ CORRECT: Sign Up

```typescript
const handleSignUp = async (email: string, password: string) => {
  const { data, error } = await supabase.auth.signUp({
    email,
    password,
    options: {
      emailRedirectTo: `${window.location.origin}/auth/callback`,
    },
  });

  if (error) {
    console.error('Sign up error:', error);
    return;
  }

  // User created, check if email confirmation is required
  if (data.user && !data.session) {
    alert('Please check your email to confirm your account');
  }
};
```

### ✅ CORRECT: Sign In

```typescript
const handleSignIn = async (email: string, password: string) => {
  const { data, error } = await supabase.auth.signInWithPassword({
    email,
    password,
  });

  if (error) {
    console.error('Sign in error:', error);
    return;
  }

  // User signed in, session available
  console.log('Session:', data.session);
};
```

### ✅ CORRECT: Magic Link (OTP)

```typescript
const handleMagicLink = async (email: string) => {
  const { error } = await supabase.auth.signInWithOtp({
    email,
    options: {
      emailRedirectTo: `${window.location.origin}/auth/callback`,
    },
  });

  if (error) {
    console.error('Magic link error:', error);
    return;
  }

  alert('Check your email for the login link!');
};

// Handle callback
useEffect(() => {
  const params = new URLSearchParams(window.location.search);
  const token_hash = params.get('token_hash');
  const type = params.get('type');

  if (token_hash) {
    supabase.auth.verifyOtp({
      token_hash,
      type: type || 'email',
    }).then(({ error }) => {
      if (error) {
        console.error('OTP verification error:', error);
      } else {
        // Successfully verified, session created
        navigate('/dashboard');
      }
    });
  }
}, []);
```

---

## Protected Routes

### ✅ CORRECT: Protected Route Component

```typescript
import { Navigate } from 'react-router-dom';
import { useAuth } from '../hooks/useAuth';

const ProtectedRoute: React.FC<{ children: React.ReactElement }> = ({ children }) => {
  const { user, loading } = useAuth();

  if (loading) {
    return <div>Loading...</div>;
  }

  if (!user) {
    return <Navigate to="/login" replace />;
  }

  return children;
};
```

### ✅ CORRECT: Auth Hook

```typescript
import { useState, useEffect } from 'react';
import { User, Session } from '@supabase/supabase-js';
import { supabase } from '../lib/supabaseClient';

export const useAuth = () => {
  const [user, setUser] = useState<User | null>(null);
  const [session, setSession] = useState<Session | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // Get initial session
    supabase.auth.getSession().then(({ data: { session } }) => {
      setSession(session);
      setUser(session?.user ?? null);
      setLoading(false);
    });

    // Listen for changes
    const {
      data: { subscription },
    } = supabase.auth.onAuthStateChange((_event, session) => {
      setSession(session);
      setUser(session?.user ?? null);
    });

    return () => subscription.unsubscribe();
  }, []);

  return { user, session, loading };
};
```

---

## Google OAuth Configuration

### ✅ CORRECT: Google Cloud Setup

1. **Create OAuth Client:**
   - Go to [Google Cloud Console](https://console.cloud.google.com/)
   - APIs & Services > Credentials
   - Create OAuth client ID (Web application)
   - **Authorized JavaScript origins:**
     - `http://localhost:3000` (development)
     - `https://your-domain.com` (production)
   - **Authorized redirect URIs:**
     - Get from Supabase Dashboard > Authentication > Providers > Google
     - Add: `https://xxxxx.supabase.co/auth/v1/callback`

2. **Configure OAuth Consent Screen:**
   - APIs & Services > OAuth consent screen
   - Choose External
   - Fill required fields
   - **Scopes:** Default (`openid`, `email`, `profile`) are sufficient

### ✅ CORRECT: Supabase Configuration

1. **Enable Google Provider:**
   - Supabase Dashboard > Authentication > Providers > Google
   - Toggle "Enable Google provider"
   - Enter Client ID and Client Secret
   - Save

2. **Get Callback URL:**
   - Copy callback URL from Supabase Dashboard
   - Add to Google OAuth client's Authorized redirect URIs

---

## Best Practices

### ✅ DO: Use Environment Variables

```typescript
// ✅ GOOD - Use env variables
const supabase = createClient(
  import.meta.env.VITE_SUPABASE_URL,
  import.meta.env.VITE_SUPABASE_ANON_KEY
);

// ❌ BAD - Hardcoded values
const supabase = createClient('https://xxx.supabase.co', 'hardcoded-key');
```

### ✅ DO: Handle Loading States

```typescript
// ✅ GOOD - Show loading while checking session
const [loading, setLoading] = useState(true);

useEffect(() => {
  supabase.auth.getSession().then(({ data: { session } }) => {
    setSession(session);
    setLoading(false);
  });
}, []);

if (loading) return <LoadingSpinner />;
```

### ✅ DO: Clean Up Subscriptions

```typescript
// ✅ GOOD - Unsubscribe on unmount
useEffect(() => {
  const { data: { subscription } } = supabase.auth.onAuthStateChange((event, session) => {
    setSession(session);
  });

  return () => subscription.unsubscribe(); // Cleanup
}, []);
```

### ✅ DO: Handle Errors Gracefully

```typescript
// ✅ GOOD - Show user-friendly errors
const handleSignIn = async (email: string, password: string) => {
  const { error } = await supabase.auth.signInWithPassword({ email, password });
  
  if (error) {
    if (error.message.includes('Invalid login')) {
      setError('Invalid email or password');
    } else {
      setError('An error occurred. Please try again.');
    }
    return;
  }
  
  // Success
};
```

### ✅ DO: Use Redirect URLs

```typescript
// ✅ GOOD - Specify redirect URL
await supabase.auth.signInWithOAuth({
  provider: 'google',
  options: {
    redirectTo: `${window.location.origin}/auth/callback`,
  },
});
```

### ❌ DON'T: Expose Service Role Key

```typescript
// ❌ BAD - Never use service_role key in frontend
const supabase = createClient(url, SERVICE_ROLE_KEY); // DANGEROUS!

// ✅ GOOD - Use anon key in frontend
const supabase = createClient(url, ANON_KEY);
```

### ❌ DON'T: Skip Error Handling

```typescript
// ❌ BAD - No error handling
await supabase.auth.signInWithPassword({ email, password });

// ✅ GOOD - Handle errors
const { error } = await supabase.auth.signInWithPassword({ email, password });
if (error) {
  console.error('Sign in error:', error);
  // Show error to user
}
```

### ❌ DON'T: Forget to Unsubscribe

```typescript
// ❌ BAD - Memory leak
useEffect(() => {
  supabase.auth.onAuthStateChange((event, session) => {
    setSession(session);
  });
  // Missing cleanup!
}, []);

// ✅ GOOD - Cleanup subscription
useEffect(() => {
  const { data: { subscription } } = supabase.auth.onAuthStateChange((event, session) => {
    setSession(session);
  });
  return () => subscription.unsubscribe();
}, []);
```

---

## Common Patterns

### Pattern 1: Auth Context Provider

```typescript
// contexts/AuthContext.tsx
import { createContext, useContext, useEffect, useState } from 'react';
import { User, Session } from '@supabase/supabase-js';
import { supabase } from '../lib/supabaseClient';

interface AuthContextType {
  user: User | null;
  session: Session | null;
  loading: boolean;
  signInWithGoogle: () => Promise<void>;
  signOut: () => Promise<void>;
}

const AuthContext = createContext<AuthContextType | undefined>(undefined);

export const AuthProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [user, setUser] = useState<User | null>(null);
  const [session, setSession] = useState<Session | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    supabase.auth.getSession().then(({ data: { session } }) => {
      setSession(session);
      setUser(session?.user ?? null);
      setLoading(false);
    });

    const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
      setSession(session);
      setUser(session?.user ?? null);
    });

    return () => subscription.unsubscribe();
  }, []);

  const signInWithGoogle = async () => {
    const { error } = await supabase.auth.signInWithOAuth({
      provider: 'google',
      options: {
        redirectTo: `${window.location.origin}/auth/callback`,
      },
    });
    
    if (error) {
      throw error;
    }
  };

  const signOut = async () => {
    await supabase.auth.signOut();
  };

  return (
    <AuthContext.Provider value={{ user, session, loading, signInWithGoogle, signOut }}>
      {children}
    </AuthContext.Provider>
  );
};

export const useAuth = () => {
  const context = useContext(AuthContext);
  if (!context) {
    throw new Error('useAuth must be used within AuthProvider');
  }
  return context;
};
```

### Pattern 2: Login Component

```typescript
// screens/Login.tsx
import { useState } from 'react';
import { useAuth } from '../hooks/useAuth';

const Login: React.FC = () => {
  const { signInWithGoogle } = useAuth();
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState<string | null>(null);

  const handleEmailLogin = async (e: React.FormEvent) => {
    e.preventDefault();
    setError(null);

    const { error } = await supabase.auth.signInWithPassword({ email, password });
    
    if (error) {
      setError(error.message);
    }
  };

  const handleGoogleLogin = async () => {
    try {
      await signInWithGoogle();
      // User will be redirected to Google, then back to callback
    } catch (error) {
      setError('Google sign-in failed');
    }
  };

  return (
    <div>
      <form onSubmit={handleEmailLogin}>
        <input
          type="email"
          value={email}
          onChange={(e) => setEmail(e.target.value)}
          placeholder="Email"
        />
        <input
          type="password"
          value={password}
          onChange={(e) => setPassword(e.target.value)}
          placeholder="Password"
        />
        <button type="submit">Sign In</button>
      </form>

      {error && <p className="error">{error}</p>}

      <button onClick={handleGoogleLogin}>
        Sign in with Google
      </button>
    </div>
  );
};
```

---

## Security Best Practices

### ✅ DO: Validate Redirect URLs

```typescript
// ✅ GOOD - Validate redirect URL
const redirectTo = `${window.location.origin}/auth/callback`;

await supabase.auth.signInWithOAuth({
  provider: 'google',
  options: {
    redirectTo, // Only redirect to your own domain
  },
});
```

### ✅ DO: Use HTTPS in Production

```typescript
// ✅ GOOD - HTTPS in production
const redirectTo = process.env.NODE_ENV === 'production'
  ? 'https://yourdomain.com/auth/callback'
  : 'http://localhost:3000/auth/callback';
```

### ✅ DO: Handle Session Expiry

```typescript
// ✅ GOOD - Listen for token refresh
supabase.auth.onAuthStateChange((event, session) => {
  if (event === 'TOKEN_REFRESHED') {
    console.log('Token refreshed');
  } else if (event === 'SIGNED_OUT') {
    // Handle session expiry
    navigate('/login');
  }
});
```

### ❌ DON'T: Store Tokens Manually

```typescript
// ❌ BAD - Don't manually store tokens
localStorage.setItem('token', session.access_token);

// ✅ GOOD - Supabase handles token storage automatically
// Just use getSession() when needed
```

---

## Error Handling

### ✅ CORRECT: Handle Auth Errors

```typescript
const handleSignIn = async (email: string, password: string) => {
  try {
    const { data, error } = await supabase.auth.signInWithPassword({
      email,
      password,
    });

    if (error) {
      // Handle specific error types
      if (error.message.includes('Invalid login')) {
        setError('Invalid email or password');
      } else if (error.message.includes('Email not confirmed')) {
        setError('Please confirm your email address');
      } else {
        setError('An error occurred. Please try again.');
      }
      return;
    }

    // Success - session is available
    console.log('Signed in:', data.session);
  } catch (err) {
    console.error('Unexpected error:', err);
    setError('An unexpected error occurred');
  }
};
```

---

## Quick Reference

### Environment Variables

```bash
# .env.local
VITE_SUPABASE_URL=https://xxxxx.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key
# OR
VITE_SUPABASE_PUBLISHABLE_DEFAULT_KEY=sb_publishable_xxx
```

### Common Methods

```typescript
// Sign in with OAuth
supabase.auth.signInWithOAuth({ provider: 'google' })

// Sign in with password
supabase.auth.signInWithPassword({ email, password })

// Sign up
supabase.auth.signUp({ email, password })

// Sign out
supabase.auth.signOut()

// Get session
supabase.auth.getSession()

// Get user
supabase.auth.getUser()

// Listen for changes
supabase.auth.onAuthStateChange((event, session) => {})
```

### Auth Events

- `SIGNED_IN` - User signed in
- `SIGNED_OUT` - User signed out
- `TOKEN_REFRESHED` - Access token refreshed
- `USER_UPDATED` - User metadata updated
- `PASSWORD_RECOVERY` - Password recovery initiated

---

## When Implementing Supabase Auth

1. **Create Supabase client** - Use environment variables
2. **Check session on mount** - Get initial session
3. **Listen for auth changes** - Update UI on sign in/out
4. **Handle OAuth callbacks** - Create callback route
5. **Protect routes** - Use ProtectedRoute component
6. **Handle errors** - Show user-friendly messages
7. **Clean up subscriptions** - Unsubscribe on unmount
8. **Use HTTPS in production** - Secure redirect URLs
9. **Validate redirect URLs** - Only allow your domain
10. **Never expose service_role key** - Use anon key in frontend

---

**References:**
- [Supabase Auth React Quickstart](https://supabase.com/docs/guides/auth/quickstarts/react)
- [Supabase Google OAuth](https://supabase.com/docs/guides/auth/social-login/auth-google)
